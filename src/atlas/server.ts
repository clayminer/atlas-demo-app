import { AtlasNextServerClient } from "@runonatlas/next/server";
import { cookies, headers } from "next/headers";
import { DiceUsageTracker } from "@/lib/dice-usage-tracker";

async function getMockUserId(): Promise<string | null> {
  try {
    // Get the authorization header
    const headersList = await headers();
    const authHeader = headersList.get('authorization');
    
    console.log('üîç Atlas Server - getMockUserId called');
    console.log('üîç Atlas Server - Auth header:', authHeader);
    
    if (authHeader && authHeader.startsWith('Bearer mock-token-')) {
      // Extract user ID from mock token
      const userId = authHeader.replace('Bearer mock-token-', '');
      console.log('‚úÖ Atlas Server - Extracted userId:', userId);
      return userId;
    }

    // Fallback: try to get from cookies (for cases where header isn't available)
    const cookieStore = await cookies();
    const authCookie = cookieStore.get('mock-auth-token');
    
    
    if (authCookie && authCookie.value.startsWith('mock-token-')) {
      const userId = authCookie.value.replace('mock-token-', '');
      return userId;
    }

    return null;
  } catch (error) {
    console.error('‚ùå Atlas Server - Error getting mock user ID:', error);
    return null;
  }
}

export const atlasServerClient = new AtlasNextServerClient(
  getMockUserId,
   {
     limits: {
       "dice-rolls": async (userId: string) => {
         try {
           // Count the user's dice rolls for the current month
           console.log('üé≤ Dice limit callback - userId:', userId);
           const rollCount = DiceUsageTracker.getRollCount(userId);
           console.log('üé≤ Dice limit callback - rollCount:', rollCount);
           return rollCount;
         } catch (error) {
           console.error('‚ùå Dice limit callback error:', error);
           // Return 0 on error to prevent 500s
           return 0;
         }
       }
     }
   }
);